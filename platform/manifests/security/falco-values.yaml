# Falco Runtime Security Configuration - Best Practices
# Container and System Runtime Security Monitoring

# Falco Configuration
falco:
  # Resource Configuration - Optimized
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Enable audit log
  auditLog:
    enabled: true
  
  # Enable syscall event sources
  syscallEventSources:
    - syscall
  
  # Custom rules for Ghost platform security
  customRules:
    rules.yaml: |
      - rule: Unexpected Ghost Process
        desc: Detect unexpected processes in Ghost containers
        condition: >
          spawned_process and
          container.name contains "ghost" and
          not proc.name in (node, npm, ghost, sh, bash, grep, awk, sed, cat, ls, ps, top, htop)
        output: >
          Unexpected process detected in Ghost container
          (user=%user.name command=%proc.cmdline container=%container.name image=%container.image)
        priority: WARNING
        tags: [process, container, ghost]
      
      - rule: Ghost Sensitive File Access
        desc: Detect access to sensitive files in Ghost containers
        condition: >
          open_read and
          container.name contains "ghost" and
          fd.name contains "/etc/passwd" or
          fd.name contains "/etc/shadow" or
          fd.name contains "/etc/hosts" or
          fd.name contains "/var/lib/ghost"
        output: >
          Sensitive file access in Ghost container
          (user=%user.name file=%fd.name container=%container.name command=%proc.cmdline)
        priority: WARNING
        tags: [file, container, ghost]
      
      - rule: Ghost Network Connection to Unknown Host
        desc: Detect network connections to unknown hosts from Ghost containers
        condition: >
          connect and
          container.name contains "ghost" and
          not fd.sip in (127.0.0.1, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16) and
          not fd.dport in (80, 443, 2368, 3306, 3000, 9090)
        output: >
          Ghost container connecting to unknown external host
          (user=%user.name sip=%fd.sip dip=%fd.dport container=%container.name command=%proc.cmdline)
        priority: WARNING
        tags: [network, container, ghost]

# Falco Exports Configuration
falcoctl:
  artifact:
    install:
      enabled: false
  
  # Enable metrics
  metrics:
    enabled: true
    
    # Prometheus metrics
    prometheus:
      enabled: true
      
      # Service Monitor for Prometheus
      serviceMonitor:
        enabled: true

# Falco Driver Configuration
driver:
  # Enable eBPF driver (modern approach)
  kind: ebpf
  
  # Resource configuration for driver loader
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 100m
      memory: 128Mi

# Audit Log Configuration
auditLog:
  # Use audit log for better security visibility
  enabled: true
  
  # Audit log format
  format: json

# Syslog Output
syslogOutput:
  # Enable syslog output for centralized logging
  enabled: true
  
  # Syslog configuration
  facility: local0
  
  # Program name
  program: falco
