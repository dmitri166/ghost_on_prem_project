name: Policy Enforcement Gates

on:
  pull_request:
    branches: [ master ]
    paths:
      - 'infrastructure/terraform/**'
      - 'applications/**'
      - 'platform/**'
      - 'policy/**'
  workflow_call:
    inputs:
      skip_policy_checks:
        description: 'Skip policy checks (for emergency)'
        required: false
        type: boolean
        default: false

env:
  POLICY_FAILURE_THRESHOLD: 0  # Number of policy failures allowed (0 = strict mode)

jobs:
  # Comprehensive Policy Validation
  policy-gate:
    runs-on: ubuntu-latest
    outputs:
      policy-check-passed: ${{ steps.policy-summary.outputs.passed }}
      critical-failures: ${{ steps.policy-summary.outputs.critical }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Tools
        uses: ./.github/actions/setup-policy-tools

      - name: Create Reports Directory
        run: mkdir -p reports

      # Infrastructure Policy Checks
      - name: Run Checkov Infrastructure Scan
        id: checkov-infra
        run: |
          checkov -d infrastructure/terraform \
            --config-file policy/checkov/checkov.yaml \
            --output json \
            --output-file-path reports/checkov-infra.json \
            --soft-fail || true
          
          # Extract results
          if [ -f reports/checkov-infra.json ]; then
            FAILED_CHECKS=$(jq '.results.failed_checks | length' reports/checkov-infra.json)
            echo "failed_checks=$FAILED_CHECKS" >> $GITHUB_OUTPUT
          else
            echo "failed_checks=0" >> $GITHUB_OUTPUT
          fi

      - name: Run tfsec Infrastructure Scan
        id: tfsec-infra
        run: |
          tfsec infrastructure/terraform \
            --config-file policy/tfsec/tfsec.toml \
            --format json \
            --out reports/tfsec-infra.json || true
          
          # Extract results
          if [ -f reports/tfsec-infra.json ]; then
            CRITICAL=$(jq '.results[] | select(.severity == "CRITICAL") | .rule_id' reports/tfsec-infra.json | wc -l)
            HIGH=$(jq '.results[] | select(.severity == "HIGH") | .rule_id' reports/tfsec-infra.json | wc -l)
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
          else
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
          fi

      # Kubernetes Policy Checks
      - name: Run OPA Kubernetes Policies
        id: opa-k8s
        run: |
          # Find all Kubernetes manifests
          find . -name "*.yaml" -o -name "*.yml" | grep -E "(k8s|kubernetes|manifests)" > k8s-files.txt
          
          TOTAL_VIOLATIONS=0
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              VIOLATIONS=$(opa eval -d policy/opa/kubernetes.rego -i "$file" "data.ghost_platform.kubernetes.deny" --format=json | jq '.result | length' 2>/dev/null || echo 0)
              TOTAL_VIOLATIONS=$((TOTAL_VIOLATIONS + VIOLATIONS))
            fi
          done < k8s-files.txt
          
          echo "violations=$TOTAL_VIOLATIONS" >> $GITHUB_OUTPUT

      # Security Policy Checks
      - name: Run Security Policy Validation
        id: security-policies
        run: |
          # Check for hardcoded secrets
          SECRET_VIOLATIONS=0
          
          # Scan for potential secrets in Terraform files
          if grep -r -i -E "(password|secret|key|token)\s*=\s*\"[^\"]+\"" infrastructure/terraform/; then
            SECRET_VIOLATIONS=$((SECRET_VIOLATIONS + 1))
          fi
          
          # Scan for insecure configurations
          INSECURE_CONFIGS=0
          if grep -r -i "privileged.*=.*true" infrastructure/terraform/ applications/ platform/; then
            INSECURE_CONFIGS=$((INSECURE_CONFIGS + 1))
          fi
          
          echo "secrets=$SECRET_VIOLATIONS" >> $GITHUB_OUTPUT
          echo "insecure=$INSECURE_CONFIGS" >> $GITHUB_OUTPUT

      # Policy Summary and Gate Decision
      - name: Policy Summary and Gate Decision
        id: policy-summary
        run: |
          TOTAL_FAILURES=$((${{ steps.checkov-infra.outputs.failed_checks }} + ${{ steps.tfsec-infra.outputs.critical }} + ${{ steps.opa-k8s.outputs.violations }} + ${{ steps.security-policies.outputs.secrets }}))
          
          echo "Total policy failures: $TOTAL_FAILURES"
          echo "Checkov failures: ${{ steps.checkov-infra.outputs.failed_checks }}"
          echo "tfsec critical: ${{ steps.tfsec-infra.outputs.critical }}"
          echo "OPA K8s violations: ${{ steps.opa-k8s.outputs.violations }}"
          echo "Security violations: ${{ steps.security-policies.outputs.secrets }}"
          
          if [ $TOTAL_FAILURES -gt $POLICY_FAILURE_THRESHOLD ]; then
            echo "Policy gate FAILED"
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "critical=$TOTAL_FAILURES" >> $GITHUB_OUTPUT
          else
            echo "Policy gate PASSED"
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "critical=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate Policy Report
        if: always()
        run: |
          cat > reports/policy-summary.md << EOF
          # Policy Enforcement Report
          
          ## Summary
          - **Total Violations**: ${{ steps.policy-summary.outputs.critical }}
          - **Policy Gate**: ${{ steps.policy-summary.outputs.passed == 'true' && 'PASSED' || 'FAILED' }}
          
          ## Detailed Results
          
          ### Infrastructure Security (Checkov)
          - Failed Checks: ${{ steps.checkov-infra.outputs.failed_checks }}
          
          ### Infrastructure Security (tfsec)
          - Critical Issues: ${{ steps.tfsec-infra.outputs.critical }}
          - High Issues: ${{ steps.tfsec-infra.outputs.high }}
          
          ### Kubernetes Security (OPA)
          - Policy Violations: ${{ steps.opa-k8s.outputs.violations }}
          
          ### Security Policies
          - Secret Violations: ${{ steps.security-policies.outputs.secrets }}
          - Insecure Configurations: ${{ steps.security-policies.outputs.insecure }}
          
          ## Recommendations
          ${{ steps.policy-summary.outputs.passed == 'true' && '✅ All policies passed. No action required.' || '❌ Policy violations detected. Please review and fix before merging.' }}
          EOF

      - name: Comment PR with Policy Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('reports/policy-summary.md', 'utf8');
            
            const emoji = '${{ steps.policy-summary.outputs.passed == 'true' && '✅' || '❌' }}';
            const status = '${{ steps.policy-summary.outputs.passed == 'true' && 'PASSED' || 'FAILED' }}';
            
            const comment = `## ${emoji} Policy Enforcement Gate - ${status}
            
            ${report}
            
            ---
            *This policy check was triggered by PR #${context.issue.number}*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload Policy Reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: policy-reports
          path: reports/
          retention-days: 30

      - name: Policy Gate Enforcement
        if: steps.policy-summary.outputs.passed != 'true' && inputs.skip_policy_checks != 'true'
        run: |
          echo "❌ Policy gate failed. Blocking merge."
          echo "Critical violations: ${{ steps.policy-summary.outputs.critical }}"
          echo "Threshold: $POLICY_FAILURE_THRESHOLD"
          exit 1

  # Compliance Dashboard Update
  update-compliance-dashboard:
    runs-on: ubuntu-latest
    needs: policy-gate
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update Compliance Metrics
        run: |
          # This would update a compliance dashboard or metrics system
          echo "Updating compliance dashboard with latest results..."
          echo "Policy gate status: ${{ needs.policy-gate.outputs.policy-check-passed }}"
          echo "Critical failures: ${{ needs.policy-gate.outputs.critical-failures }}"
